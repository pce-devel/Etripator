version: 0.7.{build}

os: Visual Studio 2017
configuration: Release

environment:
  matrix:
    - compiler: msvc-15-seh
      generator: "Visual Studio 15 2017 Win64"
      build_system: cmake
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      MSVC_PLATFORM: amd64

    - compiler: msvc-15-seh
      generator: "Visual Studio 15 2017"
      build_system: cmake
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      MSVC_PLATFORM: x86

install:
  - cd ..
  - ps: Invoke-WebRequest "https://github.com/akheron/jansson/archive/v2.12.zip" -OutFile "jansson.zip"
  - ps: Expand-Archive jansson.zip -DestinationPath .
  - cd jansson-2.12
  - md install
  - md build
  - cd build
  - cmake -DJANSSON_BUILD_DOCS=OFF -DJANSSON_WITHOUT_TESTS=ON -G "$env:generator" -DCMAKE_INSTALL_PREFIX=../install ..
  - cmake --build . --config Release
  - cmake --build . --config Release --target install
  - cd ../../Etripator


before_build:
  - call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat %MSVC_PLATFORM%"
  - mkdir install
  - mkdir build
  - cd build 
  - cmake -G "$env:generator" -DCMAKE_INSTALL_PREFIX=../install -DJANSSON_INCLUDE_DIR=../../jansson-2.12/install/include -DJANSSON_LIBRARY=../../jansson-2.12/install/lib/jansson.lib ..

build_script:
  - cmake --build . --config Release
  - cmake --build . --config Release --target install

after_build:
   - cd ../install
   - 7z a ../etripator.zip * -tzip
   
artifacts:
  - path: etripator.zip
    name: etripator-v${appveyor_build_version}-%MSVC_PLATFORM%.zip

deploy:
  release: etripator-v${appveyor_build_version}
  description: 'Etripator msvc15 win64 build'
  provider: GitHub
  auth_token:
    secure: xRIravp3mvMiAgogn6KGuK1yrolmSJUsum/wPXwu82bh97O7YkuQ3B178ac+WHml
  artifact: /etripator.*\.zip/
  draft: false
  prerelease: false
  on:
    branch: master
    appveyor_repo_tag: true  
  
